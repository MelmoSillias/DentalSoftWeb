{% extends 'appbase.html.twig' %}

{% block title %}Compléter Consultation - {{ consultation.patient.nom }}{% endblock %}

{% block stylesheets %}
  {{ parent() }}

  {# --- FilePond CSS (thème clair) --- #}
  <link href="https://unpkg.com/filepond/dist/filepond.min.css" rel="stylesheet"/>

  <style>
    /* --- Layout global --- */
    .container-fluid { padding: 1rem; }
    .card { margin-bottom: 1.5rem; }

    /* --- Floating Action Buttons --- */
    .floating-buttons {
      position: fixed;
      bottom: 20px; right: 20px;
      display: flex; flex-direction: column; gap: 0.5rem;
      z-index: 1000;
    }
    .btn-circle {
      width: 56px; height: 56px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.25rem; padding: 0;
    }
    @media (max-width: 767.98px) {
      .floating-buttons { bottom: 15px; right: 15px; }
      .btn-circle { width: 45px; height: 45px; }
    }
    @media (max-width: 575.98px) {
      .floating-buttons { bottom: 10px; right: 10px; }
      .btn-circle { width: 40px; height: 40px; }
    }

    /* --- Modals Responsives --- */
    @media (max-width: 991.98px) {
      .modal-xl { max-width: 100% !important; margin: 1rem; }
    }
    @media (max-width: 575.98px) {
      .modal-dialog { max-width: 100% !important; margin: 0.5rem; }
    }

    /* --- Tables Responsive --- */
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }

    /* --- Facture Styles --- */
    .facture-container { font-family: 'Nunito', sans-serif; color: #333; }
    .facture-header {
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 2px solid #007bff; padding-bottom: 1rem; margin-bottom: 1rem;
    }
    .facture-logo { max-width: 100px; }
    .entreprise-info { text-align: right; }
    .client-info { margin-bottom: 1.5rem; }
    .facture-meta { text-align: right; }
    .facture-table {
      width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;
    }
    .facture-table th,
    .facture-table td {
      border: 1px solid #ddd; padding: 0.75rem; text-align: left;
    }
    .facture-table th { background-color: #f8f9fc; font-weight: bold; }
    .facture-table tfoot th { text-align: right; }
    .signature-section {
      display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;
    }
    .montant-lettres { font-style: italic; }
    .cachet-space {
      width: 150px; height: 100px; border: 1px dashed #ccc;
      text-align: center; line-height: 100px; color: #999;
    }
    .facture-footer {
      text-align: center; font-size: 0.875rem; color: #666; margin-top: 2rem;
    }

    /* --- Last Consultation Card --- */
    .last-consult-card {
      position: fixed; top: 5.5rem; right: 1rem;
      width: 20rem; z-index: 1100; opacity: .5;
      transition: top .3s ease-in-out, opacity .3s ease;
    }
    .last-consult-card:hover { opacity: 1; }
    .last-consult-card .card {
      border-left: .25rem solid #4e73df;
      box-shadow: 0 .15rem 1.75rem rgba(58,59,69,.15);
    }


  </style>
{% endblock %}

{% block main %}
<div class="container-fluid px-4"> 
  {# === Section Informations du patient === #}

  <div class="card shadow mb-3">
      <!-- Card Header - Accordion -->
      <div href="#collapseCardPatientDetails" class="card-header py-3 d-flex align-items-center" data-toggle="collapse"
          role="button" aria-expanded="true" aria-controls="collapseCardPatientDetails">
          <h6 class="m-0 font-weight-bold text-primary">Informations du patient : <span class="text-gray-600 ms-2">{{ consultation.patient.nom }} {{ consultation.patient.prenom }}</span></h6>   
      </div>
      
      <!-- Card Content - Collapse -->
      <div class="collapse show" id="collapseCardPatientDetails">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Nom :</strong> {{ consultation.patient.nom }}</p>
              <p><strong>Prénom :</strong> {{ consultation.patient.prenom }}</p>
              <p><strong>Date de naissance :</strong>
                {{ consultation.patient.dateNaissance ? consultation.patient.dateNaissance|date('d/m/Y') : '–' }}
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>Sexe :</strong> {{ consultation.patient.sexe }}</p>
              <p><strong>Téléphone :</strong> {{ consultation.patient.telephone }}</p>
              <p><strong>Adresse :</strong> {{ consultation.patient.adresse }}</p>
            </div>
          </div> 
        </div>
      </div>
  </div>
  
  <div class="card shadow mb-3 accordion">
    <div href="#ficheObservationSection" class="card-header py-3 d-flex align-items-center justify-content-between" data-toggle="collapse"
        role="button" aria-expanded="true" aria-controls="ficheObservationSection"
       style="cursor: pointer;"> 
      <div class='text-primary'>
        <i class="fas fa-notes-medical me-2"></i>
        <strong>Fiche d'observation</strong>
        <span id="NewIndic" class="text-muted ms-2">: Nouvelle fiche</span>
        {% if not consultation.fiche %}
          <button id="btnNouvelleFiche" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-file-medical me-1"></i> Nouvelle fiche
          </button>
        {% endif %}
      </div>
      
    </div>

  <div id="ficheObservationSection" class="collapse show">
    <div class="card-body">
      <form id="ficheObservationForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="motif" class="form-label">Motif</label>
            <textarea id="motif" class="form-control" name="motif"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label for="histoireMaladie" class="form-label">Histoire de la maladie</label>
            <textarea id="histoireMaladie" class="form-control" name="histoireMaladie"></textarea>
          </div>
          <div class="col-md-12 mb-3">
            <label for="soinsAnterieurs" class="form-label">Soins antérieurs</label>
            <textarea id="soinsAnterieurs" class="form-control" name="soinsAnterieurs"></textarea>
          </div>
        </div>

          <div class="card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between alert alert-primary">
              <h6 class="m-0 font-weight-bold">Examens dentaires</h6>
              <button type="button" class="btn btn-sm btn-light text-darkblue" id="btnAddExamen">
                <i class="fas fa-plus me-1"></i> Ajouter
              </button>
            </div>
            <div class="card-body">
              <div id="examensContainer">
                <!-- Examens dentaires dynamiques ajoutés ici -->
              </div>
            </div>
            
          </div>

        {# === Sous-section Exo === #}
        <h6 class="mt-4 alert alert-primary"><i class="fas fa-tooth me-1"></i> Examen Exobuccal</h6>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="exoInspection" class="form-label">Inspection</label>
            <textarea id="exoInspection" class="form-control" name="exoInspection"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label for="exoPalpation" class="form-label">Palpation</label>
            <textarea id="exoPalpation" class="form-control" name="exoPalpation"></textarea>
          </div>
        </div>

        {# === Sous-section Endo === #}
        <h6 class="mt-4 alert alert-primary"><i class="fas fa-tooth me-1 "></i> Examen Endobuccal</h6>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="endoInspection" class="form-label">Inspection</label>
            <textarea id="endoInspection" class="form-control" name="endoInspection"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label for="endoPalpation" class="form-label">Palpation</label>
            <textarea id="endoPalpation" class="form-control" name="endoPalpation"></textarea>
          </div>
        </div>

        <div class="mb-3">
          <label for="occlusion" class="form-label">Occlusion</label>
          <textarea id="occlusion" class="form-control" name="occlusion"></textarea>
        </div>

        <div class="mb-3">
          <label for="examenParodontal" class="form-label">Examen parodontal</label>
          <textarea id="examenParodontal" class="form-control" name="examenParodontal"></textarea>
        </div>

        <div class="mb-3">
          <label for="diagnostic" class="form-label">Diagnostic</label>
          <textarea id="diagnostic" class="form-control" name="diagnostic"></textarea>
        </div>

        {# === Traitements === #}
        <h6 class="mt-4 alert alert-primary"><i class="fas fa-syringe me-1"></i> Traitements</h6>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="traitementUrgence" class="form-label">Urgence</label>
            <textarea id="traitementUrgence" class="form-control" name="traitementUrgence"></textarea>
          </div>
          <div class="col-md-4 mb-3">
            <label for="traitementDentaire" class="form-label">Dentaire</label>
            <textarea id="traitementDentaire" class="form-control" name="traitementDentaire"></textarea>
          </div>
          <div class="col-md-4 mb-3">
            <label for="traitementParodontal" class="form-label">Parodontal</label>
            <textarea id="traitementParodontal" class="form-control" name="traitementParodontal"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label for="traitementOrthodontique" class="form-label">Orthodontique</label>
            <textarea id="traitementOrthodontique" class="form-control" name="traitementOrthodontique"></textarea>
          </div>
          <div class="col-md-6 mb-3">
            <label for="autres" class="form-label">Autres</label>
            <textarea id="autres" class="form-control" name="autres"></textarea>
          </div>
        </div>

        {# === Examens dentaires dynamiques === #}
        
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">
              <i class="fas fa-file-medical me-2"></i> Documents médicaux
            </h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddDocument">
              <i class="fas fa-plus me-1"></i> Ajouter
            </button>
          </div>
          <div class="card-body">
            <div id="documentsContainer"></div>
          </div>
        </div>


        {# === Liste des devis === #}
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">
              <i class="fas fa-file-invoice-dollar me-2"></i>devis
            </h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddDevis">
              <i class="fas fa-plus me-1"></i> Ajouter
            </button>
          </div>
          <div class="card-body">
            <div id="devisContainer"> 
        <form id="devisForm" action="" method="post">
          <!-- Date du devis -->
          <div class="mb-3 row">
            <label for="devisDate" class="col-sm-3 col-form-label">Date</label>
            <div class="col-sm-9">
              <input type="date" class="form-control" name="date" id="devisDate" required>
            </div>
          </div>

          <hr>

          <!-- Liste dynamique des services -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Services</h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddService">
              <i class="fas fa-plus me-1"></i> Ajouter un service
            </button>
          </div>
          <div id="servicesContainer"></div>

          <hr>

          <!-- Montant total calculé -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Montant total à Payer</label>
            <div class="col-sm-9">
              <input type="text" readonly class="form-control-plaintext fw-bold fs-5" id="devisTotal" value="0.00">
            </div>
          </div>
        </form>
      </div>

      
            </div>
          </div>
        </div>

        {# === Séances (Consultations clôturées) === #}
        <div class="card mb-3 accordion mx-4">
          <div class="card-header d-flex align-items-center text-primary"
               data-bs-toggle="collapse"
               data-bs-target="#seancesPrecedentesSection"
               aria-expanded="true"
               aria-controls="seancesPrecedentesSection"
               style="cursor: pointer;">
            <i class="fas fa-stethoscope me-2"></i>
            <strong>  Séances précédentes</strong>
          </div>
          <div id="seancesPrecedentesSection" class="collapse show">
            <div class="card-body">
              <div class="row" id="seancesContainer"> 
                {% if fiche and fiche.consultations is iterable %}
                  {% for seance in fiche.consultations %}
                    {% if seance.statut == 1 %}
                      <div class="col-md-6">
                        <div class="card mb-3 border-start border-4 border-success shadow-sm">
                          <div class="card-body">
                            <h6 class="card-title text-primary mb-1">
                              <i class="fas fa-calendar-alt me-1"></i>
                              Séance du {{ seance.CreatedAt|date('d/m/Y') }}
                            </h6>
                            <p class="mb-1">
                              <strong>Médecin :</strong> {{ seance.medecin.FullName }}<br>
                              <strong>Infirmier :</strong> {{ seance.infirmier.FullName|default('—') }}<br>
                              <strong>Salle :</strong> {{ seance.salle.nom|default('—') }}
                            </p>
                            <p class="small text-muted mb-0">
                              <strong>Note :</strong> {{ seance.noteSeance|default('—') }}
                            </p>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %} 
                {% else %}
                  <div class="col-12">
                    <p class="text-muted fst-italic alert alert-secondary">Aucune séance clôturée pour cette fiche.</p>
                  </div> 
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modalNouvelleFiche" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-file-medical me-2"></i> Nouvelle fiche</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p>Voulez-vous vraiment créer une <strong>nouvelle fiche vierge</strong> ?<br>Cette action va effacer toutes les données actuelles non enregistrées.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-close" data-bs-dismiss="modal" >Annuler</button>
        <button type="button" class="btn btn-primary" id="btnConfirmNouvelleFiche">Confirmer</button>
      </div>
    </div>
  </div>
</div>



 <div class="card shadow mb-4 mx-4">
    <!-- Card Header - Accordion -->
    <div href="#CollapseConsultationSection" class="card-header py-3 d-flex align-items-center" data-toggle="collapse"
        role="button" aria-expanded="true" aria-controls="CollapseConsultationSection">
        <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-stethoscope"></i>Consultation en cours</h6>   
    </div>


    <div id="CollapseConsultationSection" class="collapse show">
      <div class="card-body">
        <form id="consultationForm">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="medecin" class="form-label">Médecin</label>
              <select class="form-select form-control" id="medecin" name="medecin">
                <option value="">–</option>
                {% for m in medecins %}
                  <option value="{{ m.id }}">{{ m.FullName }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="infirmier" class="form-label">Infirmier(ère)</label>
              <select class="form-select form-control" id="infirmier" name="infirmier">
                <option value="">–</option>
                {% for i in infirmiers %}
                  <option value="{{ i.id }}">{{ i.Fullname }}</option>
                {% endfor %}
              </select> 
            </div>
            <div class="col-md-4 mb-3">
              <label for="salle" class="form-label">Salle</label>
              <select class="form-select form-control" id="salle" name="salle">
                <option value="">–</option>
                {% for s in salles %}
                  <option value="{{ s.id }}">{{ s.nom }}</option>
                {% endfor %}
              </select> 
            </div>
          </div>

          <div class="mb-3">
            <label for="noteSeance" class="form-label">Note de séance</label>
            <textarea id="noteSeance" name="noteSeance" class="form-control" rows="2"></textarea>
          </div>

          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary d-flex align-items-center">
                <i class="fas fa-tools me-2"></i> Actes médicaux
                <button type="button" class="btn btn-sm btn-outline-primary ms-3" id="btnAddActe">
                  <i class="fas fa-plus me-1"></i> Ajouter
                </button>
              </h6>
            </div>
            <div class="card-body">
              <div id="actesContainer"></div>
            </div>
          </div>

        </form>
      </div>
    </div>
</div>

<div class="last-consult-card card shadow mb-4" id="saveStatusIndicator" >
      <div class="card-header d-flex align-items-center py-3">
        <div class="alert alert-secondary py-2 px-3 d-flex align-items-center shadow-sm mb-0 w-100 gap-2" role="alert">
          <i class="fas fa-save me-2">  </i>
          <span id="saveStatusText">Aucune modification</span>
        </div>
      </div> 
    </div>

    <div class="floating-buttons">
      <button type="button" class="btn btn-secondary shadow-sm" id="btnRetour">
    <i class="fas fa-arrow-left me-1"></i> Retour
  </button>

  <button type="button" class="btn btn-success shadow-sm" id="btnUpdateFiche">
    <i class="fas fa-save me-1"></i> Sauvegarder Fiche
  </button> 

  <button type="button" class="btn btn-danger shadow-sm" id="btnCloturerConsultation">
    <i class="fas fa-lock me-1"></i> Clôturer
  </button>
</div>

<div class="modal fade" id="modalQuitConfirm" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Modifications non sauvegardées</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        Vous avez des modifications en cours. Êtes-vous sûr de vouloir quitter cette page ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="btnQuitConfirmed">Oui, quitter</button>
      </div>
    </div>
  </div>
    </div>

<div class="modal fade" id="modalClotureConsultation" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-lock me-2"></i> Clôturer la consultation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Cette action va clôturer définitivement cette consultation. Aucune modification ne sera possible ensuite.<br>
        Voulez-vous continuer ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-close" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="btnConfirmCloture">Clôturer</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalViewDevis" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i> Détail du devis</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="devisDetailsContent">
          <!-- Contenu chargé dynamiquement par JS -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block javascripts %}
  {{ parent() }}

  {# --- FilePond JS --- #}
  <script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
  <script>
$(function() {
    // ─────────────────────────────────────────────────────────────────────────────
// I. Variables globales et suivi des modifications
// ─────────────────────────────────────────────────────────────────────────────

let isModifiedFiche = false;
let isModifiedConsultation = false;
let isNewFiche = true;
const consultId = {{ consultation.id }};
// Génère un identifiant unique avec préfixe
function uniqueId(prefix = 'id') {
  return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
}


// Met à jour l’état visuel de sauvegarde (badge flottant)
function updateSaveStatus(text = 'Aucune modification', type = 'secondary') {
  const $alert = $('#saveStatusIndicator .alert');
  const typeMap = {
    'secondary': 'alert-secondary',
    'warning':   'alert-warning',
    'success':   'alert-success'
  };

  // Nettoyer les anciennes classes alert-*
  $alert.removeClass((_, cls) => (cls.match(/alert-\S+/g) || []).join(' '));

  // Appliquer nouvelle classe et texte
  $alert.addClass(typeMap[type] || 'alert-secondary');
  $('#saveStatusText').text(text);
}

// Suivi des champs modifiés dans les deux formulaires
$('#ficheObservationForm, #consultationForm').on('input change', 'input, textarea, select', function() {
  const isFiche = $(this).closest('#ficheObservationForm').length > 0;
  if (isFiche) {
    isModifiedFiche = true;
  } else {
    isModifiedConsultation = true;
  }
  updateSaveStatus('Modifications en cours', 'warning');
});

// ─────────────────────────────────────────────────────────────────────────────
// II. Blocage du départ si modifications non sauvegardées
// ─────────────────────────────────────────────────────────────────────────────

// Intercepte la fermeture de l'onglet ou le rafraîchissement
function askBeforeUnload(e) {
  if (isModifiedFiche || isModifiedConsultation) {
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
}

// Écouteur sur la fermeture d'onglet
window.addEventListener('beforeunload', askBeforeUnload);

// Clic sur le bouton "Retour"
$('#btnRetour').on('click', function () {
  if (isModifiedFiche || isModifiedConsultation) {
    $('#modalQuitConfirm').modal('show');
  } else {
    window.history.back();
  }
});

// Confirmation de sortie depuis le modal
$('#btnQuitConfirmed').on('click', function () {
  $('#modalQuitConfirm').modal('hide');
  window.history.back();
});

// ─────────────────────────────────────────────────────────────────────────────
// III. Chargement automatique des données (loadData)
// ─────────────────────────────────────────────────────────────────────────────

function loadData() {
  const consultationId = {{ consultation.id }};

  $.getJSON(`/api/consultation/${consultationId}/json`, function(data) {
    const f = data.fiche; 
    if (f.id === null) {
      isNewFiche = true;
      $('#NewIndic').text(': Nouvelle fiche');
    } else {
      isNewFiche = false;
      $('#NewIndic').text(`: Ouverte le ${f.dateFiche}`);

    }
    // Remplir les champs de la fiche d’observation
    $('#motif').val(f.motif);
    $('#histoireMaladie').val(f.histoireMaladie);
    $('#soinsAnterieurs').val(f.soinsAnterieurs);
    $('#exoInspection').val(f.exoInspection);
    $('#exoPalpation').val(f.exoPalpation);
    $('#endoInspection').val(f.endoInspection);
    $('#endoPalpation').val(f.endoPalpation);
    $('#occlusion').val(f.occlusion);
    $('#examenParodontal').val(f.examenParodontal);
    $('#diagnostic').val(f.diagnostic);
    $('#traitementUrgence').val(f.traitementUrgence);
    $('#traitementDentaire').val(f.traitementDentaire);
    $('#traitementParodontal').val(f.traitementParodontal);
    $('#traitementOrthodontique').val(f.traitementOrthodontique);
    $('#autres').val(f.autres);

    // Réinitialiser conteneurs dynamiques
    $('#examensContainer, #documentsContainer, #actesContainer,  #seancesContainer').empty();

    // Séances précédentes
    if (Array.isArray(f.consultations) && f.consultations.length > 0) {
      f.consultations
        .filter(s => s.statut === 1)
        .forEach(s => {
          const card = $(`
            <div class="col-md-6">
              <div class="card mb-3 border-start border-4 border-success shadow-sm">
                <div class="card-body">
                  <h6 class="card-title text-primary mb-1">
                    <i class="fas fa-calendar-alt me-1"></i> Séance du ${s.date}
                  </h6>
                  <p class="mb-1">
                    <strong>Médecin :</strong> ${s.medecin}<br>
                    <strong>Infirmier :</strong> ${s.infirmier|| '—'}<br>
                    <strong>Salle :</strong> ${s.salle || '—'}
                  </p>
                  <p class="small text-muted mb-0">
                    <strong>Note :</strong> ${s.noteSeance || '—'}
                  </p>
                </div>
              </div>
            </div>
          `);
          $('#seancesContainer').append(card);
        });
    } else {
      $('#seancesContainer').append(`
        <div class="col-12">
          <p class="text-muted fst-italic">Aucune séance clôturée pour cette fiche.</p>
        </div>
      `);
    }

   // Chargement des blocs dynamiques
  (data.fiche.examens || []).forEach(addExamenBlock);
  (data.fiche.documents || []).forEach(addDocumentBlock);
  (data.actes || []).forEach(addActeBlock); 

  // Charger les données des devis
  const devis = data.fiche.devis || {};
  $('#devisDate').val(devis.date || '');
  $('#servicesContainer').empty();
  (devis.contenus || []).forEach(service => {
    const $serviceBlock = createServiceBlock(service);
    $('#servicesContainer').append($serviceBlock);
  });
  updateDevisTotal();

    // Consultation en cours
    $('#noteSeance').val(data.consultation.noteSeance);

    // Remplir les selects 
    $('#medecin').val(data.consultation.medecin?.id || '');
    $('#infirmier').val(data.consultation.infirmier?.id || '');
    $('#salle').val(data.consultation.salle?.id || ''); 

    // Réinitialiser les indicateurs
    isModifiedFiche = false;
    isModifiedConsultation = false;
    updateSaveStatus('Aucune modification', 'secondary');
  });
}

// Appel initial
loadData();
// Optionnel : rechargement périodique
// setInterval(loadData, 5 * 60 * 1000);
function collectFicheConsultationData() {
  const formData = new FormData();

  const payload = {
    isNewFiche: isNewFiche,
    motif: $('#motif').val(),
    histoireMaladie: $('#histoireMaladie').val(),
    soinsAnterieurs: $('#soinsAnterieurs').val(),
    exoInspection: $('#exoInspection').val(),
    exoPalpation: $('#exoPalpation').val(),
    endoInspection: $('#endoInspection').val(),
    endoPalpation: $('#endoPalpation').val(),
    occlusion: $('#occlusion').val(),
    examenParodontal: $('#examenParodontal').val(),
    diagnostic: $('#diagnostic').val(),
    traitementUrgence: $('#traitementUrgence').val(),
    traitementDentaire: $('#traitementDentaire').val(),
    traitementParodontal: $('#traitementParodontal').val(),
    traitementOrthodontique: $('#traitementOrthodontique').val(),
    autres: $('#autres').val(),

    examens: [],
    documents: [],
    actes: [],
    devis: {
      date: $('#devisDate').val(),
      contenus: []
    },

    consultation: {
      medecinId: $('#medecin').val(),
      infirmierId: $('#infirmier').val(),
      salleId: $('#salle').val(),
      noteSeance: $('#noteSeance').val()
    }
  };

  // Examens
  $('#examensContainer .examen-block').each(function () {
    payload.examens.push({
      date: $(this).find('.examen-date').val(),
      designation: $(this).find('.examen-designation').val(),
      resultat: $(this).find('.examen-resultat').val()
    });
  });

  // Documents (et fichiers)
  $('#documentsContainer .document-block').each(function (i) {
    payload.documents.push({
      libelle: $(this).find('.doc-libelle').val(),
      dateDossier: $(this).find('.doc-date').val(),
      description: $(this).find('.doc-description').val(),
      fichier: $(this).data('existing-url') || null
    });

    const file = $(this).find('input[type="file"]')[0]?.files[0];
    if (file) {
      formData.append(`documentsFiles[${i}]`, file);
      // On remplace l'URL par null pour indiquer qu'un nouveau fichier sera utilisé
      payload.documents[i].fichier = null;
    }
  });

  // Actes
  $('#actesContainer .acte-block').each(function () {
    payload.actes.push({
      dent: $(this).find('.acte-dent').val(),
      type: $(this).find('.acte-type').val(),
      description: $(this).find('.acte-desc').val(),
      prix: parseFloat($(this).find('.acte-prix').val()) || 0,
      quantite: parseInt($(this).find('.acte-qte').val()) || 1
    });
  });

  // Devis
  $('#servicesContainer .service-block').each(function () {
    payload.devis.contenus.push({
      designation: $(this).find('.service-designation').val(),
      qte: parseInt($(this).find('.service-qte').val()) || 1,
      montant: parseFloat($(this).find('.service-montant').val()) || 0
    });
  });

  formData.append('data', JSON.stringify(payload));
  return formData;
}

function sendFicheConsultationUpdate(formData, id) {
  $.ajax({
    url: `/api/fiche/${id}/update`,
    method: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function () {
      isModifiedFiche = false;
      isModifiedConsultation = false;
      updateSaveStatus('Fiche et consultation sauvegardées', 'success');
      showToastModal('Succès', 'Consultation enregistrée.');
      loadData();
    },
    error: function () {
      showToastModal({
        message: "Erreur lors de la sauvegarde de la fiche.",
        type: "error",
        duration: 3000
      });
    }
  });
}

$('#btnUpdateFiche').on('click', function () {
  const id = {{ consultation.id }};
  const formData = collectFicheConsultationData();
  sendFicheConsultationUpdate(formData, id);
});

function sendFicheConsultationClose(formData, id) {
   $.ajax({
    url: `/api/consultation/${id}/cloture`,
    method: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function () {
      $('#modalClotureConsultation').modal('hide');
     showToastModal({
                    message: "Clôture de la consultation.",
                    type: "success",
                    duration: 3000
                });
      window.location.href = '/admin/consultation/en-attente';
    },
    error: function () {
      showToastModal({
                    message: "Erreur lors de la clôture de la consultation.",
                    type: "error",
                    duration: 3000
                });
    }
  });
}

$('#btnCloturerConsultation').on('click', function () {
  $('#modalClotureConsultation').modal('show');
});

$('#btnConfirmCloture').on('click', function () {
  const id = consultId;
  const formData = collectFicheConsultationData();
  sendFicheConsultationClose(formData, id);
});

// Ajout examen
$('#btnAddExamen').on('click', () => addExamenBlock());

function addExamenBlock(ex = {}) {
  const uid = uniqueId('ex');
  const $blk = $(`
    <div class="examen-block mb-3" id="${uid}">
      <div class="row gx-2 align-items-end">
        <div class="col-3">
          <label>Date</label>
          <input type="date" class="form-control examen-date" value="${ex.date || ''}">
        </div>
        <div class="col-4">
          <label>Désignation</label>
          <input type="text" class="form-control examen-designation" value="${ex.designation || ''}">
        </div>
        <div class="col-4">
          <label>&nbsp;</label>
          <button type="button" class="btn btn-sm btn-outline-danger w-100 btn-remove-examen">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col">
          <label>Résultat</label>
          <textarea class="form-control examen-resultat" rows="3">${ex.resultat || ''}</textarea>
        </div>
      </div>
    </div>
  `);
  $('#examensContainer').append($blk);
}

$('#examensContainer').on('click', '.btn-remove-examen', function () {
  $(this).closest('.examen-block').remove();
});

$('#btnAddDocument').on('click', () => addDocumentBlock());

function addDocumentBlock(doc = {}) {
  const uid = uniqueId('doc');
  const $blk = $(`
   <div class="document-block mb-3" id="${uid}" data-existing-url="${doc.url || ''}">
      <div class="row gx-2">
        <div class="col-md-4">
          <label>Libellé</label>
          <input type="text" class="form-control doc-libelle" value="${doc.libelle || ''}">
        </div>
        <div class="col-md-3">
          <label>Date</label>
          <input type="date" class="form-control doc-date" value="${doc.dateDossier || ''}">
        </div>
        <div class="col-md-3 text-end d-flex align-items-end justify-content-end">
          <button type="button" class="btn btn-sm btn-outline-danger btn-remove-document">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="row mt-2 gx-2">
        <div class="col-md-6">
          <label>Description</label>
          <textarea class="form-control doc-description" rows="3">${doc.description || ''}</textarea>
        </div>
        <div class="col-md-6">
          <label>Fichier</label>
          ${doc.url ? `<p><a href="/${doc.url}" target="_blank">Voir fichier existant</a></p>` : ''}
          <input type="file" class="doc-fichier" name="documentsFiles[]">
        </div>
      </div>
    </div>
  `);
  $('#documentsContainer').append($blk);
}



$('#documentsContainer').on('click', '.btn-remove-document', function () {
  $(this).closest('.document-block').remove();
}); 

$('#btnAddActe').on('click', () => addActeBlock());

function addActeBlock(a = {}) {
  const uid = uniqueId('acte');
  const $blk = $(`
    <div class="acte-block mb-3 border" id="${uid}">
      <div class="row gx-2">
        <div class="col-md-8">
          <div class="row gx-2">
            <div class="col-md-6 mb-2">
              <label>Dent</label>
              <input type="text" class="form-control acte-dent" value="${a.dent || ''}">
            </div>
            <div class="col-md-6 mb-2">
              <label>Type</label>
              <input type="text" class="form-control acte-type" value="${a.type || ''}">
            </div>
            <div class="col-md-6">
              <label>Prix</label>
              <input type="number" step="0.01" class="form-control acte-prix" value="${a.prix || ''}">
            </div>
            <div class="col-md-6">
              <label>Quantité</label>
              <input type="number" class="form-control acte-qte" value="${a.quantite || 1}">
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <label>Description</label>
          <textarea class="form-control acte-desc" rows="4">${a.description || ''}</textarea>
        </div>
        <div class="col-md-1 text-end d-flex align-items-end">
          <button type="button" class="btn btn-sm btn-outline-danger btn-remove-acte">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `);
  $('#actesContainer').append($blk);
}

$('#actesContainer').on('click', '.btn-remove-acte', function () {
  $(this).closest('.acte-block').remove();
});


function createServiceBlock(data = {}) {
  const uid = uniqueId('service');
  const qte = data.qte || 1;
  const montant = data.montant || 0;
  const total = (qte * montant).toFixed(2);
  const $blk = $(`
    <div class="service-block border rounded p-3 mb-3" id="${uid}">
      <div class="row gx-2 align-items-end">
        <div class="col-md-5">
          <label class="form-label">Désignation</label>
          <input type="text" class="form-control service-designation" value="${data.designation || ''}" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Quantité</label>
          <input type="number" class="form-control service-qte" value="${qte}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Prix unitaire</label>
          <input type="number" class="form-control service-montant" value="${montant}" step="0.01" required>
        </div>
        <div class="col-md-1">
          <label class="form-label">Total</label>
          <input type="text" class="form-control service-total" value="${total}" readonly>
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger btn-remove-service">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `);

  $blk.on('input', '.service-qte, .service-montant', function () {
    const $parent = $(this).closest('.service-block');
    const qte = parseFloat($parent.find('.service-qte').val()) || 0;
    const prix = parseFloat($parent.find('.service-montant').val()) || 0;
    $parent.find('.service-total').val((qte * prix).toFixed(2));
    updateDevisTotal();
  });

  $blk.on('click', '.btn-remove-service', function () {
    $(this).closest('.service-block').remove();
    updateDevisTotal();
  });

  return $blk;
}

function updateDevisTotal() {
  let total = 0;
  $('#servicesContainer .service-block').each(function () {
    total += parseFloat($(this).find('.service-total').val()) || 0;
  });
  $('#devisTotal').val(total.toFixed(2));
}

$('#btnAddService').on('click', function () {
  const $blk = createServiceBlock();
  $('#servicesContainer').append($blk);
  updateDevisTotal();
}); 

function updateDevisTotal() {
  let total = 0;
  $('#servicesContainer .service-block').each(function () {
    if (!$(this).hasClass('text-decoration-line-through')) {
      total += parseFloat($(this).find('.service-total').val()) || 0;
    }
  });
  $('#devisTotal').val(total.toFixed(2));
}

$('#btnNouvelleFiche').on('click', function () {
  $('#modalNouvelleFiche').modal('show'); 
});

$('#btnConfirmNouvelleFiche').on('click', function () {
  // Effacer tous les champs de texte
  $('#ficheObservationForm textarea, #ficheObservationForm input[type="text"], #ficheObservationForm input[type="date"]').val('');

  // Vider les blocs dynamiques
  $('#examensContainer').empty();
  $('#documentsContainer').empty();
  $('#servicesContainer').empty();
  $('#devisTotal').val('0.00');

  $('#seancesContainer').empty();

  // Marquer la fiche comme nouvelle
  isNewFiche = true;

  // Fermer le modal
  $('#modalNouvelleFiche').modal('hide');

  showToastModal({message: "Nouvelle fiche créée.", type: "info", duration: 3000});
});


// Handle all close buttons to hide the closest modal
$('.btn-close').on('click', function () {
  $(this).closest('.modal').modal('hide');
});


  });
</script>

{% endblock %}
